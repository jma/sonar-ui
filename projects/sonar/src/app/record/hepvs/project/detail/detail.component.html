<!--
  SONAR User Interface
  Copyright (C) 2021 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
@if (record$ | async; as record) {
  <h1 class="mb-4">{{ record.metadata.name }}</h1>

  <sonar-record-validation [record]="record" [type]="type"></sonar-record-validation>

  <div class="my-3" *ngIf="record.metadata.keywords">
    <h5 class="d-inline mr-1" *ngFor="let keyword of record.metadata.keywords">
      <span class="badge badge-secondary text-light font-weight-light">
        <i class="fa fa-tag mx-1"></i> {{ keyword }}
      </span>
    </h5>
  </div>

  <p>
    {{ record.metadata.status }} ({{ record.metadata.startDate | dateTranslate: 'dd.MM.yyyy' }} -
    {{ record.metadata.endDate | dateTranslate: 'dd.MM.yyyy' }})
  </p>

  <p>{{ record.metadata.projectSponsor }} ({{ 'Project sponsor' | translate }}, {{ record.metadata.statusHep }})</p>

  <dl>
    <!-- Internal research associates -->
    <sonar-field-description [label]="'Internal research associates' | translate" [field]="record.metadata.innerSearcher | join:', ' "/>

    <!-- Main team -->
    <sonar-field-description [label]="'Main team' | translate" [field]="record.metadata.mainTeam"/>

    <!-- Secondary team -->
    <sonar-field-description [label]="'Secondary team' | translate" [field]="record.metadata.secondaryTeam"/>

    <!-- External partners -->
    @if (record.metadata.externalPartners.choice) {
      <sonar-field-description [label]="'External partners' | translate" [field]="record.metadata.externalPartners">
      <ng-template let-externalPartner pTemplate="template">
        @for (partner of record.metadata.externalPartners.list; track partner; let last=$last) {
          {{ partner.searcherName }}
          <i class="text-muted ml-1" *ngIf="partner.institution">{{ partner.institution }}</i>
          @if (!last) {
            ,&nbsp;
          }
        }
      </ng-template>
      </sonar-field-description>
    }

    <!-- Project summary -->
    <sonar-field-description [label]="'Project summary' | translate" [field]="record.metadata.description">
      <ng-template let-description pTemplate="template">
        <ng-core-text-read-more [text]="description"/>
      </ng-template>
    </sonar-field-description>

    <!-- Date of approval by the Team Leader -->
    <sonar-field-description [label]="'Date of approval by the Team Leader' | translate" [field]="record.metadata.approvalDate | dateTranslate: 'longDate' ">
    </sonar-field-description>

    <!-- Realization framework -->
    <sonar-field-description [label]="'Realization framework' | translate" [field]="record.metadata.realizationFramework | join:', ' "/>

    <!-- Funding -->
    @if (record.metadata.funding.choice) {
      <sonar-field-description [label]="'Funding' | translate" [field]="record.metadata.funding">
      <ng-template let-funding pTemplate="template">
        @if (funding?.funder?.number) {
          <span class="badge badge-secondary text-light mr-1">
            {{ funding.funder.number }}
          </span>
        }
        @if (funding?.funder?.name) {
          {{ funding.funder.name }}
        }
        @if (funding.funder.type != 'Other (free field)') {
          <i class="text-muted ml-1">
            {{ record.metadata.funding.funder.type }}
          </i>
        }
        @if (['â€‹Swiss National Science Foundation', 'Swissuniversities'].includes(funding.funder.type)) {
          {{ funding.funder.type }}
        }
        <i class="ml-2 fa"
        [ngClass]="{ 'fa-check text-success': funding.fundingReceived, 'fa-remove text-danger': !funding.fundingReceived }"></i>
      </ng-template>
    </sonar-field-description>
  }

    <!-- Actors involved -->
    <sonar-field-description [label]="'Actors involved' | translate" [field]="record.metadata.actorsInvolved">
      <ng-template let-actor let-last pTemplate="template">
          {{ actor.choice !== 'Other' ? actor.choice : actor.other }}  ({{ actor.count }})
          @if (!last) {
            ,&nbsp;
          }
      </ng-template>
    </sonar-field-description>

    <!-- Benefits -->
    <sonar-field-description [label]="'What are the benefits and quality improvements in the research in this project?' | translate" [field]="record.metadata.benefits">
      <ng-template let-benefit pTemplate="template">
        <ng-core-text-read-more [text]="benefit"/>
      </ng-template>
    </sonar-field-description>

    <!-- Impact on formation -->
    <sonar-field-description [label]="'What are the impacts of training research?' | translate" [field]="record.metadata.impactOnFormation">
      <ng-template let-impactOnFormation pTemplate="template">
        <ng-core-text-read-more [text]="impactOnFormation"/>
      </ng-template>
    </sonar-field-description>

    <!-- Impact on professional environment -->
    <sonar-field-description [label]="'What are the impacts of training research?' | translate" [field]="record.metadata.impactOnProfessionalEnvironment">
      <ng-template let-impactOnProfessionalEnvironment pTemplate="template">
        <ng-core-text-read-more [text]="impactOnProfessionalEnvironment"/>
      </ng-template>
    </sonar-field-description>

    <!-- Impact on public action -->
    <sonar-field-description [label]="'What is the impact of research on public action or on internal or external governance?' | translate" [field]="record.metadata.impactOnPublicAction">
      <ng-template let-impactOnPublicAction pTemplate="template">
        <ng-core-text-read-more [text]="impactOnPublicAction"/>
      </ng-template>
    </sonar-field-description>

    <!-- Promote innovation -->
    @if (record.metadata.promoteInnovation?.choice) {
    <sonar-field-description [label]="'Why this project promote pedagogical or technological innovation?' | translate" [field]="record.metadata.promoteInnovation.reason"/>
    }

    <!-- Related to mandate -->
    @if (record.metadata.relatedToMandate?.choice) {
      <sonar-field-description [label]="'Mandate' | translate" [field]="record.metadata.relatedToMandate">
        <ng-template let-relatedToMandate pTemplate="template">
          {{ relatedToMandate.mandate }}
          @if (relatedToMandate.name) {
            {{ relatedToMandate.name }}
          }
        </ng-template>
      </sonar-field-description>

      <sonar-field-description [label]="'Brief description of the mandate' | translate" [field]="record.metadata.relatedToMandate.briefDescription">
        <ng-template let-briefDescription pTemplate="template">
          <ng-core-text-read-more [text]="briefDescription"></ng-core-text-read-more>
        </ng-template>
      </sonar-field-description>
    }

    <!-- Educational document -->
    @if (record.metadata.educationalDocument?.choice) {
      <sonar-field-description [label]="'Brief description of the report' | translate" [field]="record.metadata.educationalDocument.briefDescription">
        <ng-template let-briefDescription pTemplate="template">
          <ng-core-text-read-more [text]="briefDescription"></ng-core-text-read-more>
        </ng-template>
      </sonar-field-description>
    }

    <!-- Search results valorised -->
    <sonar-field-description [label]="'How are research results used in training?' | translate" [field]="record.metadata.searchResultsValorised">
      <ng-template let-searchResultsValorised pTemplate="template">
        <ng-core-text-read-more [text]="searchResultsValorised"></ng-core-text-read-more>
      </ng-template>
    </sonar-field-description>
  </dl>

  @if (user$ | async; as user && record.metadata.documents && record.metadata.documents.length > 0 && user.is_moderator) {
    <h4 translate>Linked documents</h4>
    <ul class="list-none p-0">
      @for (document of record.metadata.documents; track document) {
        <li>
          <a
            [routerLink]="['/', 'records', 'documents', 'detail', document.pid]">{{ document.title[0].mainTitle | languageValue | async }}</a>
        </li>
      }
    </ul>
  }
}
